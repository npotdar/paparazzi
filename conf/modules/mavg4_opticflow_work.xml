<!DOCTYPE module SYSTEM "module.dtd">

<module name="mavg4_opticflow" dir="computer_vision">
  <doc>
    <description>
      Compute optical flow.
      Made for Linux video Devices.
    </description>

    <configure name="BEBOP_FRONT_CAMERA_HOST" value="192.168.1.255" description="GCS IP (default: MODEM_HOST)"/>
    <configure name="BEBOP_FRONT_CAMERA_PORT_OUT" value="5000" description="Port (default: 5000)"/>
    <configure name="BEBOP_FRONT_CAMERA_BROADCAST" value="FALSE|TRUE" description="Enable broadcast of image stream (default: TRUE)"/>

    <!-- Optical flow calculation parameters -->
    <section name="OPTICFLOW" prefix="OPTICFLOW_">
      <!-- Video device parameters -->
      <define name="DEVICE" value="/dev/video1" description="The V4L2 camera device that is used for the calculations"/>
      <define name="DEVICE_SIZE" value="1408,2112" description="The V4L2 camera device width and height"/>
      <define name="DEVICE_BUFFERS" value="15" description="Amount of V4L2 video buffers"/>
      <!--define name="SUBDEV" description="The V4L2 subdevice to initialize before the main device"/-->

      <!-- Camera parameters -->
      <define name="PROCESS_SIZE" value="272,272" description="Image size to process through opticflow width,height" />
      <define name="PADDING" value="50,50" description="FAST padding of image to define not to track edge of image points" />

      <!-- Lucas Kanade optical flow calculation parameters -->
      <define name="MAX_TRACK_CORNERS" value="25" description="The maximum amount of corners the Lucas Kanade algorithm is tracking between two frames"/>
      <define name="WINDOW_SIZE" value="10" description="Window size used in Lucas Kanade algorithm"/>
      <define name="SUBPIXEL_FACTOR" value="10" description="Amount of subpixels per pixel, used for more precise (subpixel) calculations of the flow"/>
      <define name="MAX_ITERATIONS" value="10" description="Maximum number of iterations the Lucas Kanade algorithm should take"/>
      <define name="THRESHOLD_VEC" value="2" description="TThreshold in subpixels when the iterations of Lucas Kanade should stop"/>

      <!-- FAST9 corner detection parameters -->
      <define name="FAST9_ADAPTIVE" value="TRUE" description="Whether we should use and adapative FAST9 crner detection threshold"/>
      <define name="FAST9_THRESHOLD" value="20" description="FAST9 default threshold"/>
      <define name="FAST9_MIN_DISTANCE" value="10" description="The amount of pixels between corners that should be detected"/>
    </section>

    <section name="DEBUGGER">
      <define name="PERIODIC_TELEMETRY" value="TRUE" description="Send periodic telemetry of opticflow calculations" />
    </section>
    
  </doc>

  <settings>
	<dl_settings NAME="Vision stabilization">

      <!-- Optical flow calculations parameters for Lucas Kanade and FAST9 -->
      <dl_settings name="Opticflow_M">
        <dl_setting var="opticflow.max_track_corners" module="computer_vision/mavg4_opticflow" min="0" step="1" max="100" shortname="max_trck_corners" param="OPTICFLOW_MAX_TRACK_CORNERS"/>
        <dl_setting var="opticflow.window_size" module="computer_vision/mavg4_opticflow" min="0" step="1" max="500" shortname="window_size" param="OPTICFLOW_WINDOW_SIZE"/>
        <dl_setting var="opticflow.subpixel_factor" module="computer_vision/mavg4_opticflow" min="0" step="1" max="100" shortname="subpixel_factor" param="OPTICFLOW_SUBPIXEL_FACTOR"/>
        <dl_setting var="opticflow.max_iterations" module="computer_vision/mavg4_opticflow" min="0" step="1" max="100" shortname="max_iterations" param="OPTICFLOW_MAX_ITERATIONS"/>
        <dl_setting var="opticflow.threshold_vec" module="computer_vision/mavg4_opticflow" min="0" step="1" max="100" shortname="threshold_vec" param="OPTICFLOW_THRESHOLD_VEC"/>

        <dl_setting var="opticflow.fast9_adaptive" module="computer_vision/mavg4_opticflow" min="0" step="1" max="1" values="TRUE|FALSE" shortname="fast9_adaptive" param="OPTICFLOW_FAST9_ADAPTIVE"/>
        <dl_setting var="opticflow.fast9_threshold" module="computer_vision/mavg4_opticflow" min="0" step="1" max="255" shortname="fast9_threshold" param="OPTICFLOW_FAST9_THRESHOLD"/>
        <dl_setting var="opticflow.fast9_min_distance" module="computer_vision/mavg4_opticflow" min="0" step="1" max="300" shortname="fast9_min_distance" param="OPTICFLOW_FAST9_MIN_DISTANCE"/>
      </dl_settings>

      <dl_settings name="Detection_M">
        <dl_setting var="DETECT_THRESHOLD" min="0" step="0.01" max="10" shortname="detect_thres" />
        <dl_setting var="OBS_HEADING_SET" min="0" step="1" max="180" shortname="heading_set" />
      </dl_settings>

    </dl_settings>
  </settings>

  <header>
    <file name="mavg4_opticflow.h"/>
  </header>

  <init fun="opticflow_module_init()"/>
  <periodic fun="opticflow_module_run()" start="opticflow_module_start()" stop="opticflow_module_stop()" autorun="TRUE"/>

  <makefile target="ap">
    <!-- Include the needed Computer Vision files -->
    <define name="modules/computer_vision" type="include"/>
    <file name="image.c" dir="modules/computer_vision/lib/vision"/>
    <file name="jpeg.c" dir="modules/computer_vision/lib/encoding"/>
    <file name="v4l2.c" dir="modules/computer_vision/lib/v4l"/>
    <file name="rtp.c" dir="modules/computer_vision/lib/encoding"/>

    <!-- The optical flow module (calculator) -->
    <file name="mavg4_opticflow.c"/>
    <file name="pprz_algebra_float.c" dir="math"/>
    <file name="pprz_matrix_decomp_float.c" dir="math"/>

    <!-- Main vision calculations -->
    <file name="fast_rosten.c" dir="modules/computer_vision/lib/vision"/>
    <file name="lucas_kanade.c" dir="modules/computer_vision/lib/vision"/>

    <!-- For Streaming -->
    <raw>
      include $(CFG_SHARED)/udp.makefile

      BEBOP_FRONT_CAMERA_HOST        ?= $(MODEM_HOST)
      BEBOP_FRONT_CAMERA_PORT_OUT    ?= 5000
      BEBOP_FRONT_CAMERA_BROADCAST   ?= TRUE
      BEBOP_FRONT_CAMERA_USE_NETCAT  ?= FALSE

      BEBOPVIEWVID_CFLAGS  = -DBEBOP_FRONT_CAMERA_HOST=$(BEBOP_FRONT_CAMERA_HOST) -DBEBOP_FRONT_CAMERA_PORT_OUT=$(BEBOP_FRONT_CAMERA_PORT_OUT)
      ifeq ($(BEBOP_FRONT_CAMERA_USE_NETCAT),)
        ap.CFLAGS += $(BEBOPVIEWVID_CFLAGS) -DBEBOP_FRONT_CAMERA_BROADCAST=$(BEBOP_FRONT_CAMERA_BROADCAST)
      else
        ap.CFLAGS += $(BEBOPVIEWVID_CFLAGS) -DBEBOP_FRONT_CAMERA_USE_NETCAT
      endif
    </raw>

  </makefile>

</module>

